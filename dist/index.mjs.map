{"version":3,"sources":["../src/node/cli.ts","../src/server/index.ts","../src/node/optimizer/index.ts","../src/node/constants.ts","../src/node/optimizer/scanPlugin.ts","../src/node/optimizer/preBundlePlugin.ts"],"sourcesContent":["import cac from 'cac'\nimport { startDevServer } from '../server'\n\nconst cli = cac()\n\ncli\n  .command('[root]', 'Run the development serve')\n  .alias('serve')\n  .alias('dev')\n  .action(async () => {\n    await startDevServer()\n  })\n\ncli.help()\ncli.parse()\n","import connect from 'connect'\nimport { blue, green } from 'picocolors'\nimport { optimizer } from '../node/optimizer'\n\nexport async function startDevServer() {\n  const app = connect()\n  const root = process.cwd()\n  const startTime = Date.now()\n\n  app.listen(3000, async () => {\n\t\tawait optimizer(root)\n\n    console.log(\n      green('üöÄ No-Bundle server restart done!'),\n      `${Date.now() - startTime}ms`\n    )\n\t\tconsole.log(`> local path: ${blue('http://localhost:3000')}`)\n  })\n}\n","import path from 'path'\nimport { build } from 'esbuild'\nimport { green } from 'picocolors'\nimport { scanPlugin } from './scanPlugin'\nimport { preBuildPlugin } from './preBundlePlugin'\nimport { PRE_BUNDLE_DIR } from '../constants'\n\nexport async function optimizer(root: string) {\n  const entry = path.resolve(root, 'src/main.tsx')\n  const deps = new Set<string>()\n\n  // ‰æùËµñÊü•Êâæ\n  await build({\n    entryPoints: [entry],\n    bundle: true,\n    write: false,\n    plugins: [scanPlugin(deps)]\n  })\n\n  console.log(\n    green('ÈúÄË¶ÅÈ¢ÑÊûÑÂª∫ÁöÑ‰æùËµñÊúâ: \\n'),\n    Array.from(deps)\n      .map(green)\n      .map(item => `\t${item}`)\n      .join('\\n')\n  )\n\n  // ‰æùËµñÈ¢ÑÊûÑÂª∫\n  await build({\n    entryPoints: [...deps],\n    write: true,\n    bundle: true,\n    format: 'esm',\n    splitting: true,\n    outdir: path.resolve(root, PRE_BUNDLE_DIR),\n    plugins: [preBuildPlugin(deps)]\n  })\n}\n","import path from 'path'\n\nexport const EXTERNAL_TYPES = [\n  'css',\n  'less',\n  'sass',\n  'scss',\n  'styl',\n  'stylus',\n  'pcss',\n  'postcss',\n  'vue',\n  'svelte',\n  'marko',\n  'astro',\n  'png',\n  'jpe?g',\n  'gif',\n  'svg',\n  'ico',\n  'webp',\n  'avif'\n]\n\nexport const BARE_IMPORT_RE = /^[\\w@][^:]/\n\nexport const PRE_BUNDLE_DIR = path.resolve(\"node_modules\", \".m-vite\")\n","import type { Plugin } from 'esbuild'\nimport { BARE_IMPORT_RE, EXTERNAL_TYPES } from '../constants'\n\nexport function scanPlugin(deps: Set<string>): Plugin {\n\treturn {\n\t\tname: 'esbuild:scan-deps',\n\t\n\t\tsetup(build) {\n\t\t\tbuild.onResolve({ filter: new RegExp(`\\\\.(${EXTERNAL_TYPES.join('|')})$`) }, (options) => {\n\t\t\t\treturn {\n\t\t\t\t\tpath: options.path,\n\t\t\t\t\texternal: true\n\t\t\t\t}\n\t\t\t})\n\n\t\t\tbuild.onResolve({ filter: BARE_IMPORT_RE }, (options) => {\n\t\t\t\tconst id = options.path\n\t\t\t\tdeps.add(id)\n\t\t\t\treturn {\n\t\t\t\t\tpath: id,\n\t\t\t\t\texternal: true\n\t\t\t\t}\n\t\t\t})\n\t\t}\n\t}\n}","import fse from 'fs-extra'\nimport resolve from 'resolve'\nimport path from 'path'\nimport createDebug from 'debug'\nimport { init, parse } from 'es-module-lexer'\nimport type { Plugin, Loader } from 'esbuild'\nimport { BARE_IMPORT_RE } from '../constants'\n\nconst debug = createDebug('dev')\n\nexport function preBuildPlugin(deps: Set<string>): Plugin {\n  return {\n    name: 'esbuild:pre-build',\n\n    setup(build) {\n      build.onResolve({ filter: BARE_IMPORT_RE }, resolveInfo => {\n        const { path: id, importer } = resolveInfo\n        const isEntry = !importer\n\n        if (deps.has(id)) {\n          return isEntry\n            ? {\n                path: id,\n                namespace: 'dep'\n              }\n            : {\n                // Ëß£ÊûêÂá∫‰æùËµñÁöÑÁªùÂØπË∑Ø, 'react' -> [...ÁªùÂØπË∑ØÂæÑ]/node_modules/react/index.js\n                path: resolve.sync(id, { basedir: process.cwd() })\n              }\n        }\n      })\n\n      build.onLoad({ filter: /.*/, namespace: 'dep' }, async options => {\n        await init\n        const id = options.path\n        const root = process.cwd()\n        const entryPath = resolve.sync(id, { basedir: root })\n        const code = await fse.readFile(entryPath, 'utf-8')\n        const [imports, exports] = await parse(code)\n\n\t\t\t\t// ‰ª£ÁêÜÊ®°ÂùóÁöÑ‰ΩúÁî®‰∏∫Â¢ûÂä†‰∏Ä‰∏™Êñá‰ª∂Áî®Êù•ÂØºÂá∫ es module\n        const proxyModule = []\n\n        if (!imports.length && !exports.length) {\n          // cjs Â§ÑÁêÜ\n          const specifiers = Object.keys(require(entryPath))\n          proxyModule.push(\n\t\t\t\t\t\t// exports.xx Â§ÑÁêÜ, Ëøô‰ΩøÂÖ∂ÂèØ‰ª•‰ΩøÁî® import { useState } from 'react'\n            `export { ${specifiers.join(',')} } from '${entryPath}'`,\n\t\t\t\t\t\t// export.defaults Â§ÑÁêÜ, Ëøô‰ΩøÂÖ∂ÂèØ‰ª•‰ΩøÁî® import React from 'react'\n            `export default require('${entryPath}')`\n          )\n        } else {\n          // esm Â§ÑÁêÜ\n          if (exports.includes('default' as any)) {\n            proxyModule.push(`import d from '${entryPath}'; export default d`)\n          }\n\n          proxyModule.push(`export * from '${entryPath}'`)\n        }\n\n\t\t\t\tdebug('proxy module: ', proxyModule.join('\\n'))\n\n        return {\n          resolveDir: root,\n          contents: proxyModule.join('\\n'),\n          loader: path.extname(entryPath).slice(1) as Loader // js \\ ts \\ tsx ...\n        }\n      })\n    }\n  }\n}\n"],"mappings":"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","names":["green","path","build","path","build","path","path","green"]}